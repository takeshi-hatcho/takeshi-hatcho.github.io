<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>周回カウンター（5kmマラソン）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }

    header {
      background: #1976d2;
      color: #fff;
      padding: 0.7rem 1rem;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.2rem;
    }

    header p {
      margin: 0.3rem 0 0;
      font-size: 0.9rem;
    }

    main {
      padding: 0.8rem;
      max-width: 900px;
      margin: 0 auto;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.8rem;
    }

    .controls input[type="number"] {
      width: 5rem;
      padding: 0.3rem;
      font-size: 1rem;
    }

    .btn {
      padding: 0.4rem 0.8rem;
      font-size: 0.9rem;
      border-radius: 0.5rem;
      border: none;
      cursor: pointer;
      touch-action: manipulation;
    }

    .btn-primary {
      background: #1976d2;
      color: white;
    }

    .btn-secondary {
      background: #cccccc;
      color: #333;
    }

    .btn-danger {
      background: #e53935;
      color: white;
    }

    .btn:active {
      opacity: 0.85;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 0.5rem;
      overflow: hidden;
      table-layout: fixed;
    }

    thead {
      background: #e0e0e0;
    }

    th, td {
      padding: 0.4rem;
      text-align: center;
      border-bottom: 1px solid #ddd;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    th:nth-child(1), td:nth-child(1) { width: 8%; }
    th:nth-child(2), td:nth-child(2) { width: 10%; } /* ゼッケン細く */
    th:nth-child(3), td:nth-child(3) { width: 30%; }
    th:nth-child(4), td:nth-child(4) { width: 12%; }
    th:nth-child(5), td:nth-child(5) { width: 40%; } /* 操作欄広く */

    input[type="text"] {
      width: 100%;
      padding: 0.3rem;
      box-sizing: border-box;
    }

    .lap-cell {
      font-size: 1.1rem;
      font-weight: bold;
    }

    .row-buttons {
      display: flex;
      justify-content: center;
      gap: 0.4rem;
    }

    .row-buttons .btn {
      min-width: 8rem;   /* 2.5倍の横幅 */
      padding: 0.5rem 0;
      font-size: 1.1rem;
      border-radius: 0.6rem;
    }

    tr.near-goal {
      background: #fff9c4;
    }

    tr.finished {
      background: #c8e6c9;
    }
  </style>
</head>

<body>
  <header>
    <h1>周回カウンター（5kmマラソン）</h1>
    <p>1周120m ／ 目標周回数：42周（変更可能）</p>
  </header>

  <main>
    <section class="controls">
      <label>
        目標周回数：
        <input id="goalLaps" type="number" min="1" value="42" />
      </label>

      <button class="btn btn-secondary" id="resetAllButton">全員リセット</button>
      <button class="btn btn-primary" id="exportCsvButton">CSVダウンロード</button>
      <button class="btn btn-secondary" id="clearDataButton">保存データ消去</button>
    </section>

    <table>
      <thead>
        <tr>
          <th>No.</th>
          <th>ゼッケン</th>
          <th>氏名</th>
          <th>周回数</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="runnerTableBody"></tbody>
    </table>
  </main>

<script>
  const MAX_RUNNERS = 10;
  const STORAGE_KEY = "lapCounterData_v4";

  let state = {
    goalLaps: 42,
    runners: []
  };

  /* 初期化 */
  function initState() {
    let saved = null;
    try {
      saved = localStorage.getItem(STORAGE_KEY);
    } catch {}

    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        if (parsed.runners && typeof parsed.goalLaps === "number") {
          state = parsed;
        }
      } catch {}
    }

    while (state.runners.length < MAX_RUNNERS) {
      state.runners.push({ bib: "", name: "", laps: 0 });
    }
  }

  const saveState = () =>
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));

  /* iPad対応 CSVダウンロード関数 */
  function downloadCsv(csvText) {
    const fileName = "lap_data.csv";
    const ua = navigator.userAgent;
    const isIOS = /iP(hone|od|ad)/.test(ua);

    if (isIOS) {
      // iPad/iPhone → 新しいタブで開いて保存させる
      const dataUrl = "data:text/csv;charset=utf-8," + encodeURIComponent(csvText);
      const win = window.open(dataUrl, "_blank");
      if (!win) {
        alert("CSV を開けませんでした。ポップアップブロックを解除してください。");
      } else {
        alert("開いた画面の共有ボタン（□↑）→『ファイルに保存』で保存できます。");
      }
    } else {
      // PCなど → 自動ダウンロード
      const blob = new Blob([csvText], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  }

  /* テーブル描画 */
  function renderTable() {
    const tbody = document.getElementById("runnerTableBody");
    tbody.innerHTML = "";

    state.runners.forEach((runner, index) => {
      const tr = document.createElement("tr");

      // 色分け
      const goal = state.goalLaps;
      if (runner.laps >= goal) tr.classList.add("finished");
      else if (runner.laps >= goal - 5 && runner.laps > 0)
        tr.classList.add("near-goal");

      tr.innerHTML = `
        <td>${index + 1}</td>
        <td><input type="text" value="${runner.bib}" /></td>
        <td><input type="text" value="${runner.name}" /></td>
        <td class="lap-cell">${runner.laps}</td>
        <td>
          <div class="row-buttons">
            <button class="btn btn-primary plus">＋1</button>
            <button class="btn btn-secondary minus">−1</button>
          </div>
        </td>
      `;

      const inputs = tr.querySelectorAll("input");
      inputs[0].addEventListener("input", e => {
        state.runners[index].bib = e.target.value;
        saveState();
      });

      inputs[1].addEventListener("input", e => {
        state.runners[index].name = e.target.value;
        saveState();
      });

      tr.querySelector(".plus").onclick = () => {
        state.runners[index].laps++;
        saveState();
        renderTable();
      };

      tr.querySelector(".minus").onclick = () => {
        state.runners[index].laps = Math.max(0, state.runners[index].laps - 1);
        saveState();
        renderTable();
      };

      tbody.appendChild(tr);
    });
  }

  /* イベント類 */
  document.getElementById("goalLaps").onchange = e => {
    state.goalLaps = Number(e.target.value);
    saveState();
    renderTable();
  };

  document.getElementById("resetAllButton").onclick = () => {
    if (!confirm("全員の周回数を0にしますか？")) return;
    state.runners.forEach(r => (r.laps = 0));
    saveState();
    renderTable();
  };

  document.getElementById("clearDataButton").onclick = () => {
    if (!confirm("保存データを消去しますか？")) return;
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  };

  document.getElementById("exportCsvButton").onclick = () => {
    let csv = "No,ゼッケン,氏名,周回数
";
    state.runners.forEach((r, i) => {
      csv += `${i + 1},${r.bib},${r.name},${r.laps}
`;
    });
    downloadCsv(csv);
  };

  initState();
  renderTable();
</script>
</body>
</html>
